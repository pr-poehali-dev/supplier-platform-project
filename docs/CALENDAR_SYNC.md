# Синхронизация календарей бронирования

## Описание

Система синхронизации календарей позволяет автоматически обмениваться информацией о бронированиях между вашим сайтом и внешними площадками (Авито, Яндекс.Путешествия, Booking.com и др.).

## Возможности

### 1. Экспорт календаря
- Экспорт ваших броней в формате iCalendar (.ics)
- Автоматическое обновление занятых дат на внешних площадках
- Предотвращение двойных бронирований

### 2. Импорт календаря
- Импорт броней с внешних площадок
- Автоматическая блокировка занятых дат
- Синхронизация по требованию или по расписанию

## Как настроить

### Шаг 1: Добавление синхронизации

1. Перейдите в админ-панель → "Синхронизация календарей"
2. Нажмите "Добавить синхронизацию"
3. Выберите объект размещения и площадку
4. Нажмите "Добавить"

### Шаг 2: Настройка экспорта

**Для Авито:**
1. Войдите в личный кабинет Авито
2. Откройте объявление → Настройки календаря
3. Найдите опцию "Импорт из внешнего календаря"
4. В админке TourConnect скопируйте ссылку экспорта
5. Вставьте её в поле на Авито и сохраните

**Для Яндекс.Путешествий:**
1. Войдите в личный кабинет партнёра
2. Выберите объект → Календарь → Настройки
3. Добавьте внешний календарь
4. Вставьте ссылку экспорта из TourConnect

### Шаг 3: Настройка импорта

**Для Авито:**
1. В личном кабинете Авито найдите "Экспорт календаря"
2. Скопируйте ссылку на календарь
3. В TourConnect вставьте её в поле "URL календаря для импорта"
4. Нажмите "Синхронизировать"

**Для Яндекс.Путешествий:**
1. В личном кабинете найдите ссылку на календарь
2. Скопируйте её
3. Вставьте в TourConnect и синхронизируйте

## API Endpoints

### GET /calendar-export
Экспортирует календарь броней в формате iCalendar

**Параметры:**
- `unit_id` - ID объекта размещения

**Ответ:**
```
Content-Type: text/calendar
BEGIN:VCALENDAR
...
END:VCALENDAR
```

### GET /calendar-sync-list
Получить список настроенных синхронизаций

**Параметры (опционально):**
- `unit_id` - фильтр по объекту

**Ответ:**
```json
{
  "syncs": [
    {
      "id": 1,
      "unit_id": 1,
      "platform": "avito",
      "calendar_url": "https://...",
      "is_active": true,
      "last_sync_at": "2025-01-09T10:30:00",
      "created_at": "2025-01-09T10:00:00"
    }
  ]
}
```

### POST /calendar-sync-add
Добавить новую синхронизацию

**Тело запроса:**
```json
{
  "unit_id": 1,
  "platform": "avito",
  "calendar_url": "https://..."
}
```

### PUT /calendar-sync-update
Обновить синхронизацию

**Тело запроса:**
```json
{
  "id": 1,
  "calendar_url": "https://...",
  "is_active": true
}
```

### DELETE /calendar-sync-delete
Удалить синхронизацию

**Параметры:**
- `id` - ID синхронизации

### POST /calendar-sync-now
Запустить синхронизацию немедленно

**Тело запроса:**
```json
{
  "id": 1
}
```

**Ответ:**
```json
{
  "message": "Sync completed",
  "imported_events": 3
}
```

## База данных

### Таблица calendar_sync

```sql
CREATE TABLE calendar_sync (
    id SERIAL PRIMARY KEY,
    unit_id INTEGER NOT NULL,
    platform VARCHAR(50) NOT NULL, -- 'avito', 'yandex', 'booking', etc.
    calendar_url TEXT,              -- URL для импорта
    is_active BOOLEAN DEFAULT true,
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(unit_id, platform)
);
```

### Поле source в bookings

Добавлено поле `source` для отслеживания источника брони:
- `website` - бронь с сайта
- `telegram` - бронь через Telegram
- `avito` - импортирована с Авито
- `yandex` - импортирована с Яндекс
- и т.д.

## Примечания

1. **Формат iCalendar** - стандартный формат для обмена календарями
2. **Автоматическое обновление** - площадки обычно обновляют календарь каждые 6-12 часов
3. **Ручная синхронизация** - можно запустить в любой момент через кнопку "Синхронизировать"
4. **Предотвращение дублей** - система проверяет пересечения перед импортом

## Решение проблем

**Проблема:** Календарь не обновляется на площадке
- Проверьте, что ссылка экспорта корректно вставлена
- Подождите 6-12 часов для автоматического обновления
- Проверьте, что на площадке включён импорт внешних календарей

**Проблема:** Импорт не работает
- Убедитесь, что ссылка на внешний календарь доступна
- Проверьте формат ссылки (должна начинаться с https://)
- Нажмите "Синхронизировать" для ручного запуска

**Проблема:** Двойные бронирования
- Система автоматически проверяет пересечения
- Убедитесь, что синхронизация активна
- Проверьте статус последней синхронизации
