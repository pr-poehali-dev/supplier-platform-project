# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa –ø–æ–¥–ø–∏—Å–æ–∫

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### Backend —Ñ—É–Ω–∫—Ü–∏–∏ (–∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã):
- **subscription-create** - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–∞—Ä—Ç—ã
  - URL: `https://functions.poehali.dev/2caae688-634f-4a76-b90b-0009fc13ee84`
- **subscription-charge** - cron –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
  - URL: `https://functions.poehali.dev/7929e0cc-a291-41ac-9e44-42a0c5e3acb0`
- **subscription-cancel** - –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
  - URL: `https://functions.poehali.dev/7f98ad7b-9f7c-4157-a5ab-7ba03dd634e5`
- **subscription-get** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∏
  - URL: `https://functions.poehali.dev/578f8247-37f6-47e4-a3ce-744df886fc3f`
- **yookassa-webhook** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –æ—Ç –ÆKassa
  - URL: `https://functions.poehali.dev/60bc374a-26cd-48ca-994a-7f9f46660e2b`

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `subscription_plans` —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ (Start, Pro, Business)
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `payment_methods` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∫–∞—Ä—Ç
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `subscriptions` –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –¢–∞–±–ª–∏—Ü–∞ `subscription_payments` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

### Frontend:
- ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/pricing` –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `SubscriptionCard` –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- ‚úÖ –•—É–∫ `useSubscription` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å

### 1. –°–µ–∫—Ä–µ—Ç—ã –ÆKassa
–î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç:
- `YOOKASSA_SHOP_ID` - Shop ID –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ÆKassa
- `YOOKASSA_SECRET_KEY` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á API

**–ì–¥–µ –Ω–∞–π—Ç–∏:**
1. Shop ID: [https://yookassa.ru/my/payments](https://yookassa.ru/my/payments) (–≤ —à–∞–ø–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
2. Secret Key: [https://yookassa.ru/my/merchant/integration/api-keys](https://yookassa.ru/my/merchant/integration/api-keys) ‚Üí –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á

### 2. Webhook –≤ –ÆKassa
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:

**URL webhook:**
```
https://functions.poehali.dev/60bc374a-26cd-48ca-994a-7f9f46660e2b
```

**–û—Ç–º–µ—Ç—å—Ç–µ —Å–æ–±—ã—Ç–∏—è:**
- ‚úÖ `payment.succeeded` - —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂
- ‚úÖ `payment.waiting_for_capture` - –ø–ª–∞—Ç—ë–∂ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- ‚úÖ `payment.canceled` - –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂
- ‚úÖ `refund.succeeded` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤

**–ì–¥–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:**
[https://yookassa.ru/my/merchant/integration/http-notifications](https://yookassa.ru/my/merchant/integration/http-notifications)

### 3. Cron –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ `subscription-charge` –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 MSK.

**–§—É–Ω–∫—Ü–∏—è:**
```
https://functions.poehali.dev/7929e0cc-a291-41ac-9e44-42a0c5e3acb0
```

**–ú–µ—Ç–æ–¥:** POST (–±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)

**‚ö†Ô∏è –í–∞–∂–Ω–æ:** –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –±–µ–∑ —É—á–∞—Å—Ç–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞!

### 4. JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ!** –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç JWT –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
- `subscription-create` - —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—É—á–∞–µ—Ç `user_id`
- `subscription-cancel` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω—è–µ—Ç —Å–≤–æ—é –ø–æ–¥–ø–∏—Å–∫—É
- `subscription-get` - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥—É–ª—å `jwt_utils.py`** –≤ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `get_user_id(auth_header)`

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
- [x] ~~–î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY`~~ ‚úÖ –ì–æ—Ç–æ–≤–æ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ÆKassa
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è `subscription-charge` (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00)
- [x] ~~–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é~~ ‚úÖ –ì–æ—Ç–æ–≤–æ

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –í–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –≤ –ÆKassa
- [ ] –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —Å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π `5555 5555 5555 4477`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `payment_method_id` –≤ –ë–î
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `subscription-charge` –≤—Ä—É—á–Ω—É—é ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ
- [ ] –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é –∫–∞—Ä—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook: —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ ‚Üí —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏–ª—Å—è

### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:
- `5555 5555 5555 4477` - —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- `5555 5555 5555 4444` - –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ `sub-{id}-{date}`  
‚úÖ Webhook –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ GET-–∑–∞–ø—Ä–æ—Å –∫ API –ÆKassa  
‚úÖ –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ÆKassa)  
‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–ø–∏—Å–∞–Ω–∏–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞)  
‚úÖ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö –ø–æ–¥–ø–∏—Å–æ–∫  

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
- **400/403 –æ—Ç –ÆKassa** ‚Üí –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è `payment_method`, –ø–æ–¥–ø–∏—Å–∫–∞ ‚Üí `payment_failed`
- **Webhook –¥—É–±–ª–∏–∫–∞—Ç—ã** ‚Üí UNIQUE constraint –Ω–∞ `yookassa_payment_id`
- **–ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω, webhook –Ω–µ –ø—Ä–∏—à—ë–ª** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é

---

## üöÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç—ë–∂ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏):
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –Ω–∞ `/pricing`
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `subscription-create` —Å `plan_id`, `user_email`
3. Backend —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ –≤ –ÆKassa —Å `save_payment_method=true`
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã webhook —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `payment_method_id` –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É

### –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏:
1. Cron –∑–∞–ø—É—Å–∫–∞–µ—Ç `subscription-charge` –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
2. –§—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏ —Å `current_period_end <= now + 1 day`
3. –°–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ `payment_method_id` (–±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
4. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ ‚Üí –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç `current_period_end` –Ω–∞ 30 –¥–Ω–µ–π
5. –ü—Ä–∏ –æ—à–∏–±–∫–µ ‚Üí –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É, –ø–æ–¥–ø–∏—Å–∫–∞ ‚Üí `payment_failed`

### –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å" –≤ –ø—Ä–æ—Ñ–∏–ª–µ
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `subscription-cancel`
3. Backend –ø–æ–º–µ—á–∞–µ—Ç `payment_method.is_active = false`
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `cancel_at_period_end = true`
5. –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç—Å—è (—Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `cancel_at_period_end`)

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Frontend (/pricing)
    ‚Üì –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
Backend (subscription-create)
    ‚Üì —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å save_payment_method
–ÆKassa (–ø–ª–∞—Ç—ë–∂–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
    ‚Üì –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç
Webhook (yookassa-webhook)
    ‚Üì —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ payment_method_id
Database (subscriptions + payment_methods)
    ‚Üì
Cron (subscription-charge) ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
    ‚Üì –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ payment_method_id
–ÆKassa API
    ‚Üì —Å–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
Webhook ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
```

---

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. **–õ–æ–≥–∏ backend —Ñ—É–Ω–∫—Ü–∏–π** - –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
2. **–¢–∞–±–ª–∏—Ü—É subscription_payments** - —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–µ–π –∏ `error_message`
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ –ÆKassa** - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏ —Å–æ–±—ã—Ç–∏—è
4. **–°–µ–∫—Ä–µ—Ç—ã** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY`

**–ü–æ–ª–µ–∑–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã:**
```sql
-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
SELECT * FROM subscriptions WHERE status = 'active';

-- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
SELECT * FROM subscription_payments WHERE status = 'failed' ORDER BY created_at DESC;

-- –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
SELECT * FROM payment_methods WHERE is_active = false;
```