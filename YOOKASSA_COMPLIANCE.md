# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ÆKassa

## ‚úÖ 1. –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:
> –°—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–µ–Ω –ø–æ–∑–≤–æ–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã.
> –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –æ—Ç–≤—è–∑–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞, –∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã.

### ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

**–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞: `/profile` (–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `SubscriptionCard`
- –ö–Ω–æ–ø–∫–∞ –æ—Ç–≤—è–∑–∫–∏: –∏–∫–æ–Ω–∫–∞ üóëÔ∏è —Ä—è–¥–æ–º —Å –Ω–æ–º–µ—Ä–æ–º –∫–∞—Ä—Ç—ã

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–¥–ø–∏—Å–∫–∞"
2. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –æ—Ç–≤—è–∑–∫–∏ (–∏–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã)
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ
4. –°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
   - `payment_method.is_active = false`
   - `payment_method.deactivated_at = NOW()`
   - `subscription.cancel_at_period_end = true`
   - `subscription.cancelled_at = NOW()`
5. –ö–∞—Ä—Ç–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
6. –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç—Å—è

**–ö–æ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

```typescript
// src/components/subscription/SubscriptionCard.tsx
{subscription.payment_method && (
  <div className="flex items-center justify-between">
    <div className="flex items-center gap-2">
      <Icon name="CreditCard" size={16} />
      <span>
        {subscription.payment_method.card_type} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {subscription.payment_method.card_last4}
      </span>
    </div>
    {!subscription.cancel_at_period_end && (
      <Button
        variant="ghost"
        size="sm"
        onClick={onCancel}
        className="text-red-600"
        title="–û—Ç–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É"
      >
        <Icon name="Trash2" size={14} />
      </Button>
    )}
  </div>
)}
```

```python
# backend/subscription-cancel/index.py (—Å—Ç—Ä–æ–∫–∏ 140-153)
# Deactivate payment method (–æ—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã)
if payment_method_id:
    cur.execute(f"""
        UPDATE {S}payment_methods
        SET is_active = false, deactivated_at = %s
        WHERE id = %s
    """, (now, payment_method_id))

# Mark subscription as cancel_at_period_end
cur.execute(f"""
    UPDATE {S}subscriptions
    SET cancel_at_period_end = true, cancelled_at = %s
    WHERE id = %s
""", (now, subscription_id))
```

**‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:**
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ÆKassa API
- ‚úÖ –ö–∞—Ä—Ç–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã (is_active = false)
- ‚úÖ –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ

---

## ‚úÖ 2. –ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –≤—ã–ø–∏—Å–∫–∏

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:
> –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –º–∞–≥–∞–∑–∏–Ω–∞ –¥–ª—è –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –≤—ã–ø–∏—Å–∫–∏.
> –§–æ—Ä–º–∞—Ç: 14 —Å–∏–º–≤–æ–ª–æ–≤ (¬´YM*¬ª + –µ—â—ë 11). –î–æ–ø—É—Å—Ç–∏–º—ã –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ –∑–Ω–∞–∫–∏ ¬´.¬ª, ¬´-¬ª, ¬´_¬ª, ¬´ ¬ª
> –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —Å–≤—è–∑–∞–Ω–æ —Å –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–º –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:**
```
YM*TourConnect
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
- ‚úÖ –î–ª–∏–Ω–∞: 15 —Å–∏–º–≤–æ–ª–æ–≤ (YM* + 12) ‚Äî —É–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –ª–∏–º–∏—Ç
- ‚úÖ –§–æ—Ä–º–∞—Ç: YM* + –ª–∞—Ç–∏–Ω–∏—Ü–∞
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å: –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å—É—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (—Ç—É—Ä–±–∞–∑—ã, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
- ‚úÖ –°–≤—è–∑—å —Å –ø—Ä–æ–µ–∫—Ç–æ–º: –¥–æ–º–µ–Ω `tourconnect.ru`

**–ì–¥–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è:**
- –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ù–∞–∑–≤–∞–Ω–∏–µ –≤ –≤—ã–ø–∏—Å–∫–µ

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:**
- `YM*TourRental` (14 —Å–∏–º–≤–æ–ª–æ–≤)
- `YM*BookingRent` (15 —Å–∏–º–≤–æ–ª–æ–≤)
- `YM*RentConnect` (15 —Å–∏–º–≤–æ–ª–æ–≤)

**‚ùó –î–µ–π—Å—Ç–≤–∏–µ:**
–í–ª–∞–¥–µ–ª–µ—Ü –¥–æ–ª–∂–µ–Ω –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —ç—Ç–æ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
1. –í–æ–π—Ç–∏ –≤ https://yookassa.ru/my
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
3. –£–∫–∞–∑–∞—Ç—å "–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã–ø–∏—Å–∫–∏": `YM*TourConnect`

---

## ‚úÖ 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ÆKassa

### 3.1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –§–ª–∞–≥ `save_payment_method = true` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

```python
# backend/subscription-create/index.py (—Å—Ç—Ä–æ–∫–∞ 81)
"save_payment_method": True
```

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**

---

### 3.2. Merchant Customer ID
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ

```python
# backend/subscription-create/index.py (—Å—Ç—Ä–æ–∫–∞ 87)
"merchant_customer_id": customer_email
```

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### 3.3. Webhook –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```python
# backend/yookassa-webhook/index.py (—Å—Ç—Ä–æ–∫–∏ 114-125)
# Security: Verify payment via API (most reliable)
verified_payment = verify_payment_via_api(payment_id, shop_id, secret_key)
if not verified_payment:
    return {'statusCode': 400, 'body': json.dumps({'error': 'Payment verification failed'})}
```

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** ‚Äî webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç payment —á–µ—Ä–µ–∑ GET –∑–∞–ø—Ä–æ—Å –∫ API

---

### 3.4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∞
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è `payment.canceled`

```python
# backend/yookassa-webhook/index.py (—Å—Ç—Ä–æ–∫–∏ 194-207)
elif payment_status == 'canceled':
    # Update payment record as failed
    cur.execute(f"""
        UPDATE {S}subscription_payments
        SET status = 'canceled', updated_at = %s
        WHERE yookassa_payment_id = %s
    """, (now, payment_id))
```

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**

---

### 3.5. –ß–µ–∫–∏ (54-–§–ó)
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —á–µ–∫–∞ –ø—Ä–∏ –ø–ª–∞—Ç–µ–∂–µ

```python
# backend/subscription-create/index.py (—Å—Ç—Ä–æ–∫–∏ 88-101)
"receipt": {
    "customer": {
        "email": customer_email
    },
    "items": [{
        "description": description[:128],
        "quantity": "1.000",
        "amount": {
            "value": f"{amount:.2f}",
            "currency": "RUB"
        },
        "vat_code": 1,
        "payment_subject": "service",
        "payment_mode": "full_payment"
    }]
}
```

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**

---

## üìã Checklist –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ÆKassa

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [x] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è
- [x] Webhook URL: `https://functions.poehali.dev/832197cf-32de-4104-b098-202eb2f469d3`
- [x] –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`
- [x] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook —á–µ—Ä–µ–∑ API
- [x] –§–ª–∞–≥ `save_payment_method = true`
- [x] Merchant Customer ID –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
- [x] –ß–µ–∫–∏ 54-–§–ó —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
- [x] –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- [x] –ö–∞—Ä—Ç–∞ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ
- [x] –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–µ–∫—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ
- [x] –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
- [x] –î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa:
- [ ] –£–∫–∞–∑–∞–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: `YM*TourConnect`
- [ ] –í–∫–ª—é—á–µ–Ω—ã –Ω—É–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è webhook
- [ ] URL webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º:
1. –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã ‚Äî —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. –ö–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ (`YM*TourConnect`)
3. Webhook ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
4. –ß–µ–∫–∏ 54-–§–ó ‚Äî —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è
5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å "–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" –≤ –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
2. –î–æ–±–∞–≤–∏—Ç—å URL webhook –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
3. –í—ã–±—Ä–∞—Ç—å —Å–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ÆKassa! üöÄ**
