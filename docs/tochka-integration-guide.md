# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¢–æ—á–∫–∞ –ë–∞–Ω–∫

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

### 1. Backend —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã
- **tochka-subscription** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏  
  URL: `https://functions.poehali.dev/2e481bdd-814f-4a67-a604-c4dfa33d848c`

- **tochka-callback** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã  
  URL: `https://functions.poehali.dev/83c679fe-d952-4080-902a-14548ff7da79`

- **tochka-webhook** ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö  
  URL: `https://functions.poehali.dev/f44bba27-a610-42b6-b8b3-8ef531be217a`

### 2. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–¢–∞–±–ª–∏—Ü–∞ `subscriptions` —Å–æ–∑–¥–∞–Ω–∞ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:
- `id` ‚Äî UUID –ø–æ–¥–ø–∏—Å–∫–∏
- `user_id` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `plan_code` ‚Äî —Ç–∞—Ä–∏—Ñ (start/pro/business)
- `amount` ‚Äî —Å—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö
- `status` ‚Äî —Å—Ç–∞—Ç—É—Å (pending/active/expired/cancelled)
- `tochka_subscription_id` ‚Äî ID –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –¢–æ—á–∫–∞ –ë–∞–Ω–∫
- `next_charge_date` ‚Äî –¥–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è
- `expires_at` ‚Äî –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

### 3. Frontend
- `/pricing` ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–∞—Ä–∏—Ñ–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ–ø–ª–∞—Ç—ã
- `/subscription-status` ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 4. –°–µ–∫—Ä–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã
- `TOCHKA_CLIENT_ID` ‚Äî ‚úÖ
- `TOCHKA_CLIENT_SECRET` ‚Äî ‚úÖ

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∞ –ë–∞–Ω–∫

### –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redirect URI
1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¢–æ—á–∫–∞ –ë–∞–Ω–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
3. –î–æ–±–∞–≤—å—Ç–µ Redirect URI:
   ```
   https://functions.poehali.dev/83c679fe-d952-4080-902a-14548ff7da79
   ```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook
1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "Webhooks"
2. –î–æ–±–∞–≤—å—Ç–µ webhook URL:
   ```
   https://functions.poehali.dev/f44bba27-a610-42b6-b8b3-8ef531be217a
   ```
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:
   - ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (PAID/SUCCESS)
   - ‚úÖ –ù–µ—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (FAILED/ERROR)
   - ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (permissions)
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:
- `MakeAcquiringOperation` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
- `ReadAcquiringData` ‚Äî —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —ç–∫–≤–∞–π—Ä–∏–Ω–≥–∞
- `ManageWebhookData` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ webhook

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
```bash
curl -X POST https://functions.poehali.dev/2e481bdd-814f-4a67-a604-c4dfa33d848c \
  -H "Content-Type: application/json" \
  -H "X-User-Id: 1" \
  -d '{"plan_code": "start"}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{
  "paymentUrl": "https://enter.tochka.com/connect/authorize?client_id=...",
  "subscriptionId": "uuid",
  "amount": 2450,
  "purpose": "–ü–æ–¥–ø–∏—Å–∫–∞ TourConnect ‚Äî START"
}
```

### 2. –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –æ–ø–ª–∞—Ç—ã
1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://tourconnect.ru/pricing
2. –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π —Ç–∞—Ä–∏—Ñ
3. –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"
4. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¢–æ—á–∫–∞ –ë–∞–Ω–∫
5. –í–æ–π–¥–∏—Ç–µ –≤ —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
6. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
7. –í—ã –≤–µ—Ä–Ω—ë—Ç–µ—Å—å –Ω–∞ `/subscription-status?status=success`
8. –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –ë–î:
```sql
SELECT id, user_id, plan_code, amount, status, 
       next_charge_date, expires_at, created_at
FROM subscriptions
ORDER BY created_at DESC;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏:
```sql
SELECT u.id, u.email, u.subscription_plan, u.subscription_expires_at,
       s.plan_code, s.status, s.next_charge_date
FROM users u
JOIN subscriptions s ON s.user_id = u.id
WHERE s.status = 'active'
ORDER BY s.next_charge_date;
```

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ

–¢–æ—á–∫–∞ –ë–∞–Ω–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü:
1. –ó–∞ 3 –¥–Ω—è –¥–æ `next_charge_date` ‚Äî –ø–æ–ø—ã—Ç–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è
2. –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Üí webhook –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Üí webhook –æ—Ç–ø—Ä–∞–≤–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –æ—Ç–º–µ–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É

**–í–ê–ñ–ù–û:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–ø–∏—Å–∞–Ω–∏—è!  
(—Å–º. —Å—Ç—Ä–æ–∫—É 119 –≤ `backend/tochka-webhook/index.py`)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Redirect URI** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω–æ —Ç–∞–∫–∏–º –∂–µ –≤:
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¢–æ—á–∫–∞ –ë–∞–Ω–∫
   - –ö–æ–¥–µ `tochka-subscription/index.py` (—Å—Ç—Ä–æ–∫–∞ 104)
   - –ö–æ–¥–µ `tochka-callback/index.py` (—Å—Ç—Ä–æ–∫–∞ 46)

2. **Webhook URL** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∞ –ë–∞–Ω–∫

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook** —Å–µ–π—á–∞—Å –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ (—Å—Ç—Ä–æ–∫–∏ 26-33 –≤ `tochka-webhook/index.py`).  
   –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç `TOCHKA_WEBHOOK_SECRET`

4. **–¢–∞—Ä–∏—Ñ—ã** –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω—ã –≤ –∫–æ–¥–µ:
   - START: 2 450 ‚ÇΩ
   - PRO: 4 490 ‚ÇΩ
   - BUSINESS: 7 490 ‚ÇΩ

5. **–†–µ–∫—É—Ä—Ä–µ–Ω—Ç** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 30 –¥–Ω–µ–π + 3 –¥–Ω—è grace period

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ backend —Ñ—É–Ω–∫—Ü–∏–π –≤ dashboard
2. –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–æ–∫ –≤ –ë–î
3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å redirect_uri –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –¢–æ—á–∫–∞ –ë–∞–Ω–∫
4. –ù–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö permissions —É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## ‚ú® –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redirect URI –∏ Webhook –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –¢–æ—á–∫–∞ –ë–∞–Ω–∫ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏—ë–º—É –ø–ª–∞—Ç–µ–∂–µ–π! üöÄ
