# –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫ YooKassa

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ (START/PRO/BUSINESS)
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"
3. –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
4. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ YooKassa –¥–ª—è –æ–ø–ª–∞—Ç—ã
5. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã webhook –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É:
   - `status = 'active'`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç payment_method (–∫–∞—Ä—Ç—É)
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `activated_at`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `subscription-create` –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (—Å—Ç–∞—Ç—É—Å `replaced`)
- `yookassa-webhook` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂
- `subscription-get` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É

---

### 2. –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
2. –°–∏—Å—Ç–µ–º–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç:
   - `cancel_at_period_end = true`
   - `cancelled_at = NOW()`
   - `payment_method.is_active = false` (–∫–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑–∞–Ω–∞)
3. –ü–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è `status = 'active'` –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
4. –î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–æ `current_period_end`

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `subscription-cancel` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–º–µ–Ω—É –ë–ï–ó –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ YooKassa
- –ö–∞—Ä—Ç–∞ –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (cron –Ω–µ —Å–ø–∏—à–µ—Ç –¥–µ–Ω—å–≥–∏)
- –ü–æ—Å–ª–µ `current_period_end` cron –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ `expired`

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è YooKassa:**
- ‚úÖ –û—Ç–º–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `payment_method.is_active = false` –±–ª–æ–∫–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏
- ‚ùó –ù—É–∂–µ–Ω cron –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ `expired` –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞

---

### 3. –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ (upgrade/downgrade)
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ (–Ω–∞–ø—Ä–∏–º–µ—Ä, START ‚Üí PRO)
2. –°–∏—Å—Ç–µ–º–∞:
   - –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (`status = 'replaced'`)
   - –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`
   - –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É
3. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
4. –°—Ç–∞—Ä–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- `subscription-create` –≤—ã–ø–æ–ª–Ω—è–µ—Ç UPDATE —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (—Å—Ç—Ä–æ–∫–∞ 235-238)
- `subscription-get` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:
  1. `active` –±–µ–∑ –æ—Ç–º–µ–Ω—ã
  2. `active` —Å –æ—Ç–º–µ–Ω–æ–π
  3. `pending`

**‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ user_id=23:**
- PRO –æ—Ç–º–µ–Ω–µ–Ω–∞: `cancel_at_period_end=true`, `status=active`
- START –∞–∫—Ç–∏–≤–Ω–∞: `status=active`, `cancel_at_period_end=false`
- subscription-get –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç START (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

---

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `SubscriptionGuard` –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä—è (`/booking-calendar`)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ (maxUnits) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç API –≤–º–µ—Å—Ç–æ localStorage (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ `subscription-get`
- ‚úÖ –£—á–∏—Ç—ã–≤–∞–µ—Ç `cancel_at_period_end` (–¥–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫:**
```sql
ORDER BY 
    CASE 
        WHEN status = 'active' AND cancel_at_period_end = false THEN 1
        WHEN status = 'active' AND cancel_at_period_end = true THEN 2
        WHEN status = 'pending' THEN 3
        ELSE 4
    END,
    created_at DESC
```

---

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"
2. –°–∏—Å—Ç–µ–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `subscription-get` —á–µ—Ä–µ–∑ API
3. –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ UI

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π `/refresh?action=refresh` (401 –æ—à–∏–±–∫–∏)
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `useSubscription().refetch()`
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

### 6. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (cron)
**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å (–ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û –ü–û–õ–ù–û–°–¢–¨–Æ):**
1. Cron –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 –ú–°–ö
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –≥–¥–µ `current_period_end < NOW()`
3. –ï—Å–ª–∏ `cancel_at_period_end = true`:
   - –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –≤ `status = 'expired'`
4. –ï—Å–ª–∏ `cancel_at_period_end = false` –∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞:
   - –°–æ–∑–¥–∞–µ—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ YooKassa API
   - –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç `current_period_end` –Ω–∞ 30 –¥–Ω–µ–π

**‚ö†Ô∏è TODO:**
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å cron –¥–ª—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è –Ω–µ–æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π (`status = 'payment_failed'`)

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å YooKassa

### –û—Ç–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. ‚úÖ `payment_method.is_active = false` –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
2. ‚úÖ `payment_method.deactivated_at` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
3. ‚úÖ Cron –Ω–µ –±—É–¥–µ—Ç —Å–ø–∏—Å—ã–≤–∞—Ç—å —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç

### Webhook –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç payment_id —á–µ—Ä–µ–∑ GET –∑–∞–ø—Ä–æ—Å –∫ YooKassa API
- ‚úÖ –ù–µ –¥–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–º –∏–∑ webhook
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î (user_id=23)

```sql
-- –ê–∫—Ç–∏–≤–Ω–∞—è START –ø–æ–¥–ø–∏—Å–∫–∞
id: cd12935d-5eee-4587-927d-56247c715917
plan_code: start
status: active
cancel_at_period_end: false
current_period_end: 2026-02-27

-- –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è PRO –ø–æ–¥–ø–∏—Å–∫–∞
id: 5d4a6054-8319-41e2-bdcd-c8cbf7148c45
plan_code: pro
status: active
cancel_at_period_end: true
cancelled_at: 2026-01-28T19:47:27
payment_method.is_active: false
```

**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:** subscription-get –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç START (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ)

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¢–æ–∫–µ–Ω—ã 401 –≤ –ª–æ–≥–∞—Ö
**–ü—Ä–∏—á–∏–Ω–∞:** Access token –∏—Å—Ç–µ–∫–∞–µ—Ç, refresh –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å auth extension –∏ refresh token logic

### 2. localStorage cache
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- UserProfile —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `useSubscription()` hook
- SubscriptionGuard –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API –≤–º–µ—Å—Ç–æ localStorage

### 3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- subscription-create –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π
- subscription-get –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Checklist –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- [x] –ü–æ–∫—É–ø–∫–∞ –ø–µ—Ä–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- [x] –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î)
- [x] –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ (START ‚Üí PRO ‚Üí START)
- [x] –î–æ—Å—Ç—É–ø –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ
- [x] –î–æ—Å—Ç—É–ø –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é –ø—Ä–∏ –æ—Ç–º–µ–Ω—ë–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ (–¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞)
- [ ] –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ current_period_end
- [ ] –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç cron)

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è YooKassa:
- [x] payment_method.is_active = false –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
- [x] cancel_at_period_end —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [x] Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ API
- [ ] Cron –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç—ë–∂ –¥–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
